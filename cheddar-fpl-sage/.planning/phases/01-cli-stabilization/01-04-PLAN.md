---
phase: 01-cli-stabilization
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/cheddar_fpl_sage/analysis/enhanced_decision_framework.py
  - src/cheddar_fpl_sage/analysis/fpl_sage_integration.py
  - src/cheddar_fpl_sage/validation/data_gate.py
autonomous: true

must_haves:
  truths:
    - "No bare 'except Exception:' handlers in analysis and validation modules"
    - "Specific exceptions caught (KeyError, ValueError, TypeError)"
    - "Exception context preserved with 'raise X from e'"
    - "Ctrl+C (KeyboardInterrupt) works properly during analysis"
  artifacts:
    - path: "src/cheddar_fpl_sage/analysis/enhanced_decision_framework.py"
      provides: "Specific exception handling"
      contains: "except (KeyError, ValueError"
    - path: "src/cheddar_fpl_sage/analysis/fpl_sage_integration.py"
      provides: "Specific exception handling for integration"
      contains: "raise DataValidationError"
    - path: "src/cheddar_fpl_sage/validation/data_gate.py"
      provides: "Specific exception handling for validation"
      contains: "except (KeyError, TypeError, ValueError)"
  key_links:
    - from: "analysis modules"
      to: "decision_framework/exceptions.py"
      via: "imports"
      pattern: "from .decision_framework import.*Error"
---

<objective>
Replace bare `except Exception:` handlers with specific exception types in analysis and validation modules.

Purpose: Stop masking bugs with catch-all handlers. Specific exceptions enable targeted recovery (retry on network, fail on validation) and preserve debugging information. Ctrl+C must work properly.

Output: Analysis and validation modules (~30 handlers) use specific exception types. Custom exceptions from Plan 01 used.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cli-stabilization/01-RESEARCH.md
@.planning/phases/01-cli-stabilization/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix exception handling in enhanced_decision_framework.py</name>
  <files>
    src/cheddar_fpl_sage/analysis/enhanced_decision_framework.py
  </files>
  <action>
Replace bare exception handlers in the main decision framework file (9 instances found via grep).

Search for `except Exception` and replace based on context:

**Pattern 1 - Data parsing failures:**
```python
# BEFORE (line ~142)
try:
    report = InjuryReport.from_dict(entry)
except Exception as exc:
    logger.warning("Failed to parse injury report entry: %s", exc)
    continue

# AFTER
try:
    report = InjuryReport.from_dict(entry)
except (KeyError, ValueError, TypeError) as exc:
    logger.warning("Failed to parse injury report entry: %s", exc)
    continue
```

**Pattern 2 - Player lookup failures:**
```python
# BEFORE
try:
    player_data = projections.get(player_id)
except Exception:
    player_data = None

# AFTER
try:
    player_data = projections.get(player_id)
except (KeyError, TypeError) as exc:
    logger.debug("Player %s lookup failed: %s", player_id, exc)
    player_data = None
```

**Pattern 3 - Numeric conversions:**
```python
# BEFORE
try:
    value = float(some_string)
except Exception:
    value = 0.0

# AFTER
try:
    value = float(some_string)
except (ValueError, TypeError) as exc:
    logger.debug("Numeric conversion failed for '%s': %s", some_string, exc)
    value = 0.0
```

For each handler:
1. Identify what operations are in the try block
2. List the specific exceptions those operations can raise
3. Replace with tuple of specific exceptions
4. Add `from e` when re-raising to preserve context

CRITICAL:
- Never catch `BaseException` - that catches KeyboardInterrupt
- Use `except Exception as e:` only if you genuinely need catch-all (rare)
- Always log the exception type and message
- Use `raise NewError(...) from e` to preserve stack trace
  </action>
  <verify>
```bash
# Count remaining bare handlers in enhanced_decision_framework
grep -c "except Exception" src/cheddar_fpl_sage/analysis/enhanced_decision_framework.py || echo "0"
# Target: 0

# Test Ctrl+C works (should exit cleanly, not hang)
timeout 2 python -c "
from cheddar_fpl_sage.analysis.enhanced_decision_framework import EnhancedDecisionFramework
print('Import OK - Ctrl+C would work')
" || echo "Import failed - check for syntax errors"
```
  </verify>
  <done>No bare 'except Exception:' in enhanced_decision_framework.py. All handlers use specific types.</done>
</task>

<task type="auto">
  <name>Task 2: Fix exception handling in fpl_sage_integration.py and data_gate.py</name>
  <files>
    src/cheddar_fpl_sage/analysis/fpl_sage_integration.py
    src/cheddar_fpl_sage/validation/data_gate.py
  </files>
  <action>
Replace bare exception handlers in integration and validation modules.

**fpl_sage_integration.py** (21+ instances found - most in codebase):
Group by type:

- JSON parsing: `except json.JSONDecodeError as e:`
- Dict access: `except (KeyError, TypeError) as e:`
- File I/O: `except (FileNotFoundError, PermissionError, IOError) as e:`
- Network/async: `except (aiohttp.ClientError, asyncio.TimeoutError) as e:`
- Validation: `except (ValueError, TypeError) as e:`

Example transformation:
```python
# BEFORE (line ~209)
try:
    result = await self._fetch_data(url)
except Exception as exc:
    logger.error("Failed to fetch: %s", exc)
    return None

# AFTER
import aiohttp
try:
    result = await self._fetch_data(url)
except aiohttp.ClientError as exc:
    logger.error("Network error fetching %s: %s", url, exc)
    return None
except asyncio.TimeoutError as exc:
    logger.error("Timeout fetching %s: %s", url, exc)
    return None
```

**data_gate.py** (2 instances):
```python
# Line ~34: Timestamp parsing
# BEFORE
try:
    age = self._parse_timestamp(ts)
except Exception:
    age = 1e9  # Silent fallback!

# AFTER
try:
    age = self._parse_timestamp(ts)
except (ValueError, TypeError) as exc:
    logger.warning("Timestamp parse failed for '%s': %s, treating as stale", ts, exc)
    age = 1e9

# Line ~112: Data validation
# BEFORE
try:
    self._validate_structure(data)
except Exception:
    return False

# AFTER
try:
    self._validate_structure(data)
except (KeyError, TypeError, ValueError) as exc:
    logger.debug("Structure validation failed: %s", exc)
    return False
```

Add imports at top of files:
```python
from cheddar_fpl_sage.analysis.decision_framework import DataValidationError
```
  </action>
  <verify>
```bash
# Count remaining bare handlers
grep -c "except Exception" src/cheddar_fpl_sage/analysis/fpl_sage_integration.py || echo "0"
grep -c "except Exception" src/cheddar_fpl_sage/validation/data_gate.py || echo "0"

# Run relevant tests
pytest tests/tests_new/test_data_gate.py -v -x 2>/dev/null || echo "No data_gate tests yet"
pytest tests/ -x -q --tb=short
```
  </verify>
  <done>No bare handlers in fpl_sage_integration.py or data_gate.py. Custom exceptions imported and used. Ctrl+C works.</done>
</task>

</tasks>

<verification>
Exception cleanup for analysis/validation modules complete:
```bash
# Count all remaining bare handlers in analysis and validation
echo "Bare handlers in analysis:"
grep -c "except Exception" src/cheddar_fpl_sage/analysis/*.py || echo "0"
echo "Bare handlers in validation:"
grep -c "except Exception" src/cheddar_fpl_sage/validation/*.py || echo "0"

# Verify Ctrl+C works
python -c "
import asyncio
from cheddar_fpl_sage.analysis.fpl_sage_integration import FPLSageIntegration
print('Import OK - KeyboardInterrupt would propagate')
"

# Test suite
pytest tests/ -v --tb=short
```
</verification>

<success_criteria>
- Zero bare `except Exception:` handlers in enhanced_decision_framework.py
- Zero bare `except Exception:` handlers in fpl_sage_integration.py
- Zero bare `except Exception:` handlers in data_gate.py
- Each handler catches specific types (KeyError, ValueError, aiohttp.ClientError, etc.)
- Custom exceptions (DataValidationError) used where appropriate
- `raise X from e` pattern used when re-raising
- Ctrl+C (KeyboardInterrupt) works - script exits immediately
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-cli-stabilization/01-04-SUMMARY.md`
</output>
