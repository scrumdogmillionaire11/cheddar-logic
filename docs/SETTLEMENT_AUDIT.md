# Settlement Tracking Audit — 2026-02-28

## Summary

The schema for full projection settlement is fully in place. The auto-enrollment pipeline (card insert -> card_result row) is wired and working. The missing piece is a settlement worker that fetches final game scores and flips card_results from `pending` to `win/loss/push`.

---

## What Exists (Schema)

| Table | Purpose | Status |
|-------|---------|--------|
| `card_payloads` | Generated driver plays per game | Active — populated by NHL/NBA/NCAAM model jobs |
| `card_results` | Settlement row per card (pending -> win/loss/push) | Schema exists, auto-enrolled on insert |
| `game_results` | Final scores from external source | Schema exists, zero rows (no ingest job) |
| `tracking_stats` | Pre-computed P&L analytics | Schema exists, zero rows (no compute job) |

---

## What Is Wired

### Auto-enrollment (WORKING)
Every call to `insertCardPayload()` in `packages/data/src/db.js` immediately calls `insertCardResult()` with `status: 'pending'`. This means every card generated by the NHL, NBA, and NCAAM models already has a corresponding `card_results` row waiting for settlement. No manual enrollment step needed.

### Schema coverage (COMPLETE)
- `card_results` tracks: card_id, game_id, sport, card_type, recommended_bet_type, status, result, settled_at, pnl_units
- `game_results` tracks: game_id, final_score_home, final_score_away, status (in_progress/final/cancelled/postponed), result_source, settled_at
- `tracking_stats` tracks: segmented win rates, P&L, confidence calibration by sport/market/direction/tier/driver/period

---

## What Is Missing (Gap)

### Gap 1: No game result ingest job (CRITICAL)
There is no worker job that fetches final game scores and populates `game_results`. The `upsertGameResult()` function exists in `db.js` but is never called by any scheduler job. Without final scores, no card can be settled.

**Required:** A `settle_games` job (or extension of `pull_odds_hourly`) that:
1. Fetches game status/scores from the odds API or ESPN after game time passes
2. Calls `upsertGameResult()` for each completed game
3. Runs on a post-game window (e.g., T+3 hours or a nightly sweep)

### Gap 2: No card settlement logic (CRITICAL)
There is no job that reads completed `game_results` rows, determines win/loss for each prediction, and updates `card_results.status` from `pending` to a final value.

**Required:** A `settle_cards` job that:
1. Queries `card_results WHERE status = 'pending'`
2. Joins with `game_results WHERE status = 'final'`
3. For each card: reads `prediction` (HOME/AWAY) from `card_payloads.payload_data`, compares to actual winner from final scores
4. Updates `card_results SET status='settled', result='win'|'loss'|'push', settled_at=now, pnl_units=...`

### Gap 3: No tracking_stats compute job (DOWNSTREAM)
`tracking_stats` is designed to hold pre-computed aggregates. Nothing populates it. This is downstream of Gap 2 — fix gaps 1 and 2 first.

---

## Settlement Logic (When Built)

Win/loss determination for moneyline cards:
- Prediction = HOME, home_score > away_score → WIN
- Prediction = HOME, home_score < away_score → LOSS
- Prediction = HOME, home_score == away_score → PUSH (rare in NHL/NBA)
- Prediction = AWAY, away_score > home_score → WIN
- Prediction = AWAY, away_score < home_score → LOSS
- Prediction = NEUTRAL → no settlement needed (skip)

pnl_units calculation (standard -110 vig):
- WIN: +0.909 units (bet 1.1, win 2.0, net +0.909)
- LOSS: -1.0 units
- PUSH: 0.0 units

---

## Recommended Next Steps

1. **Quick: Add game result ingest** — Extend `pull_odds_hourly` to also detect games where `game_time_utc < now` and odds API returns a final score, then call `upsertGameResult()`. This reuses the existing fetch infra.

2. **Quick: Add card settlement sweep** — New job `settle_pending_cards` that runs nightly (or post-game window). Reads final game_results, resolves pending card_results, writes win/loss/pnl_units.

3. **Later: tracking_stats compute** — Once card_results has real settled data, a weekly cron aggregates into tracking_stats for the analytics view.

---

## Confidence: Schema Readiness

The schema is production-ready. The foreign keys, indexes, and `stat_key` pipe-delimited format are well designed. The auto-enrollment is a good pattern. Building the settlement worker is the only remaining work.
