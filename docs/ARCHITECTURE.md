# 2️⃣ `docs/ARCHITECTURE.md`

```md
# Architecture Overview

## Goal

Serve cheddarlogic.com with two distinct product lines:

1. **Sports Betting Dashboard** — Analytical cards for NBA/NHL/MLB/Soccer betting
2. **FPL-SAGE Dashboard** — Fantasy Premier League tools (squad planning, transfers, chips)

Both use shared infrastructure (Web + Worker + Database) but have different data models, scheduling patterns, and UX contracts.

---

## Products (User-Facing)

### A) Sports Betting Dashboard

**Routes:**
- `/betting` (global view)
- `/betting/nba`, `/betting/nhl`, `/betting/mlb`
- `/betting/soccer` (EPL/MLS/UCL with subfilters)

**Renders:**
- Analytical cards generated by betting models
- Confidence scores, predictions, reasoning, odds context
- Expiry-aware (cards expire before game start)
- Mock inference badges (safety flag)

**Data Sources:**
- Odds snapshots (moneyline, spread, total)
- Injuries, lineups, starters (soccer-critical)
- Public betting splits (optional)

### B) FPL-SAGE Dashboard

**Routes:**
- `/fpl` (overview)
- `/fpl/squad`, `/fpl/transfers`, `/fpl/chips`, `/fpl/planner`

**Renders:**
- Transfer recommendations
- Multi-week squad planners
- Chip usage strategies
- Player projections (xGI, minutes, price changes)

**Data Sources:**
- FPL official API (fixtures, deadlines, player stats)
- User squad inputs (stored in DB)
- Custom heuristics/projections

**Critical Distinction:**
FPL-SAGE is NOT soccer betting. It's fantasy sports with different cadence (deadline-driven vs game-time) and different data contracts.

---

## Runtime Components

### 1. Web — `apps/web`

**Responsibilities:**
- Hosts cheddarlogic.com routes for both product lines
- Reads from DB (never recomputes heavy logic)
- Displays staleness indicators (last updated timestamps)
- Filters/sorts/searches (lightweight operations only)

**Does NOT:**
- Run inference models
- Pull external data
- Compute projections or recommendations

---

### 2. Worker — `apps/worker`

Single worker process with two operational domains:

#### Domain 1 — Betting Engine (Multi-Sport)

**Sports:**
- NBA, NHL, MLB (internal models + odds-driven)
- Soccer Betting (EPL, MLS, UCL) — treated as betting models with lineup/injury dependencies

**Inputs (Shared Ingestion):**
- Odds snapshots (moneyline, spread, totals)
- Fixtures/games table
- Injuries
- Lineups/starters (critical for soccer)
- Public splits (optional for EV calculations)

**Outputs:**
- `model_outputs` (raw predictions, confidence, drivers, metadata)
- `card_payloads` (frontend-ready cards with `card_type=nba-model-output`, etc.)

**Scheduling:**
- **Fixed runs:** 09:00 ET, 12:00 ET (daily)
- **T-minus windows:** T-120, T-90, T-60, T-30 (relative to game start time)
- Idempotent via `job_key` format: `sport|windowType|context|value`
  - Examples: `nhl|fixed|2026-02-27|0900`, `nhl|tminus|nhl-2026-02-27-van-sea|120`

**Job Names:**
- `pull_odds_hourly`
- `run_nba_model`, `run_nhl_model`, `run_mlb_model`
- `run_soccer_epl_model`, `run_soccer_mls_model`, `run_soccer_ucl_model` (future)

#### Domain 2 — FPL-SAGE Engine

**Inputs (NOT Odds-Driven):**
- FPL official API (fixtures, deadlines, player data)
- User squad inputs (entered via web, stored in DB)
- Player snapshots (prices, form, minutes, xGI)
- Custom heuristics or projections

**Outputs:**
- `fpl_recommendations` table OR `card_payloads` with `card_type=fpl-sage-*`
- `fpl_plans` (multi-week transfer plans)
- UI-ready payloads (different schema from betting cards)

**Scheduling:**
- **Deadline-based cadence:** Daily refresh + pre-deadline ramp (e.g., T-48h, T-24h, T-6h before GW deadline)
- Does NOT use game-time T-minus logic (fantasy deadlines are weekly, not per-match)
- Idempotent via `job_key` format: `fpl|deadline|GW27|T-24h`, `fpl|daily|2026-02-27`

**Job Names:**
- `pull_fpl_data_daily`
- `run_fpl_transfers_engine`
- `run_fpl_squad_optimizer`

---

### 3. Database — Shared Data Layer

**Shared Tables (Cross-Domain):**
- `job_runs` (idempotency + audit for both domains)
- `card_payloads` (can be used by both domains with different `card_type` values)

**Betting Domain Tables:**
- `games` (fixtures with start times)
- `odds_snapshots` (moneyline, spread, totals)
- `model_outputs` (betting predictions, confidence, drivers)
- `injuries` (future)
- `lineups` (future, soccer-critical)

**FPL-SAGE Domain Tables (Separate Namespace):**
- `fpl_user_squads` (user-entered teams)
- `fpl_deadlines` (gameweek deadlines)
- `fpl_player_snapshots` (prices, form, minutes)
- `fpl_recommendations` (transfer suggestions, chip timing)
- `fpl_plans` (multi-week strategies)

**Key Boundary:**
FPL data must NOT pollute betting tables. Each domain maintains its own source tables. They can share `card_payloads` for rendering, but ingestion stays separate.

---

## Data Flow

### Betting Domain

```
External APIs (odds, injuries, lineups)
    ↓
Adapters (packages/adapters/odds/*)
    ↓
Canonical Snapshots (odds_snapshots, games, injuries)
    ↓
Sport Runners (apps/worker/src/jobs/betting/*)
    ↓
model_outputs + card_payloads
    ↓
Web renders betting dashboard
```

### FPL-SAGE Domain

```
FPL Official API
    ↓
Adapters (packages/adapters/fpl_api/*)
    ↓
FPL Snapshots (fpl_player_snapshots, fpl_deadlines)
    ↓
FPL Runners (apps/worker/src/jobs/fpl/*)
    ↓
fpl_recommendations + card_payloads (card_type=fpl-sage-*)
    ↓
Web renders FPL dashboard
```

---

## Scheduling Model

### Betting Engine Scheduling

**Ingestion:**
- Odds: hourly, idempotent via `job_key=odds|hourly|YYYY-MM-DD|HH`
- Injuries/lineups: more frequent near game time (future)

**Inference:**
- **Fixed daily builds:** 09:00 ET, 12:00 ET
  - `job_key=nhl|fixed|YYYY-MM-DD|0900`
- **T-minus windows:** T-120, T-90, T-60, T-30 (relative to each game start)
  - `job_key=nhl|tminus|<game_id>|120`
- Tolerance band: ±5 minutes per window
- T-120 triggers only when `minutes_to_start` is within **[115, 125]** (±5 min tolerance around 120).
- A game 150 minutes away (outside [115, 125]) should NOT trigger T-120. This is correct behavior.

**Implementation:**
- Tick loop runs every 60 seconds
- `computeDueJobs(now, games[])` returns list of `(jobName, jobKey, args)`
- `shouldRunJobKey(jobKey)` prevents re-execution (skip if success/running, allow if failed)

### FPL-SAGE Scheduling (Distinct Pattern)

**Ingestion:**
- Daily FPL data refresh: 03:00 ET
  - `job_key=fpl|daily|YYYY-MM-DD`

**Recommendation Engine:**
- Deadline-relative windows: T-48h, T-24h, T-6h before gameweek deadline
  - `job_key=fpl|deadline|GW27|T-24h`
- NOT game-time driven (fantasy deadlines are weekly/bi-weekly, not per-match)

**Implementation:**
- Same tick loop, different window detection logic
- Use `fpl_deadlines` table for target timestamps (not `games` table)

---

## Reliability Rules

1. **Every job writes to `job_runs`** (idempotency + audit)
2. **All runner outputs are persisted** (model_outputs, card_payloads, fpl_recommendations)
3. **Web renders last known good payload** (never recomputes)
4. **Staleness is visible in UI** (last updated timestamps, expiry indicators)
5. **No runtime recomputation in web layer** (all logic pre-executed by worker)
6. **Idempotency everywhere** (deterministic `job_key` prevents double-firing across restarts)

---

## Service Boundary Rules

**Adapters (`packages/adapters`):**
- External IO only (odds APIs, FPL API, injury feeds)
- Normalize to canonical schema
- Return structured data

**Data Package (`packages/data`):**
- Schema + migrations
- DB access functions
- Validators (Zod schemas)
- No business logic

**Core Package (`packages/core`):**
- Shared utilities (date formatting, timezone conversions)
- Types/interfaces
- Constants

**Worker (`apps/worker`):**
- Orchestration + runners
- Inference execution
- Scheduling logic (tick loop)
- Job idempotency enforcement

**Web (`apps/web`):**
- Rendering only
- API routes read from DB
- No compute

**No additional services without documented justification.**

---

## Code Layout (Target Structure)

```
apps/
  worker/
    src/
      jobs/
        betting/
          run_nba_model.js
          run_nhl_model.js
          run_mlb_model.js
          run_soccer_epl_model.js (future)
        fpl/
          run_fpl_transfers_engine.js
          run_fpl_squad_optimizer.js
        ingestion/
          pull_odds_hourly.js
          pull_fpl_data_daily.js
      schedulers/
        main.js (single tick loop)
        windows/
          betting-windows.js (T-minus + fixed logic)
          fpl-windows.js (deadline-relative logic)
      models/
        betting/ (NHL/NBA/MLB/Soccer inference)
        fpl/ (FPL-SAGE recommendation logic)
  web/
    src/
      app/
        betting/ (betting dashboard routes)
        fpl/ (FPL-SAGE dashboard routes)
        api/
          cards/ (shared card endpoint)
          betting/ (betting-specific if needed)
          fpl/ (FPL-specific if needed)

packages/
  data/ (shared DB + migrations)
  adapters/
    odds/
    soccer_lineups/
    injuries/
    fpl_api/
  core/ (shared utils)
  models/ (future: extracted model logic)
```

---

## Non-Negotiable Boundaries

1. **FPL-SAGE is its own domain:** No odds, no T-minus game windows. Deadline-driven with weekly/bi-weekly cadence.
2. **Soccer betting models belong to betting domain:** Same contract as NHL/NBA/MLB (odds + T-minus windows).
3. **Web only renders:** It can filter/search/sort, but it doesn't compute predictions or recommendations.
4. **Everything persists:** Worker writes outputs to DB; web reads stored payloads.
5. **Idempotency everywhere:** Deterministic `job_key` prevents double-firing across restarts and failures.
6. **No new services:** Single worker, single web app, shared database. Scaling happens via horizontal worker replication (future) or Postgres migration (if needed).

---

## Timezone Rules

- **Storage:** All timestamps in UTC (ISO 8601)
- **Operational timezone:** America/New_York (Eastern Time)
  - Fixed windows computed in ET (09:00 ET = 14:00 UTC in winter, 13:00 UTC in summer)
  - UI displays can be user-localized, but scheduler runs in ET

---

## Migration Path (Current → Target)

**Current State:**
- Betting models: NBA, NHL, MLB, NFL (working)
- FPL treated as betting model (WRONG — needs refactor)
- Scheduler uses intervals (needs window upgrade)

**Target State:**
- Betting models: NBA, NHL, MLB, Soccer (EPL/MLS/UCL)
- FPL-SAGE as separate domain with deadline scheduling
- Scheduler uses window detection + idempotency

**Next Steps:**
1. Upgrade scheduler to window-based (betting domain first)
2. Refactor FPL from betting-style to deadline-style
3. Add soccer betting models (EPL/MLS/UCL)
4. Extract FPL tables from betting namespace